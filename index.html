<!DOCTYPE html>
<html>

<head>
    <title>D&D Character Creator</title>
    <link rel="stylesheet" href="static/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Cinzel:wght@400;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêâ</text></svg>">
</head>

<body>

    <!-- Vignette overlay -->
    <div class="vignette"></div>

    <!-- Corner sword decorations -->
    <div class="corner-sword top-left">‚öî</div>
    <div class="corner-sword top-right">‚öî</div>
    <div class="corner-sword bottom-left">‚öî</div>
    <div class="corner-sword bottom-right">‚öî</div>

    <!-- Floating particles/embers effect -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Left Side Class Icons Column -->
    <div class="side-icons left-icons">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <!-- Repeat for seamless loop -->
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
    </div>

    <!-- Right Side Class Icons Column -->
    <div class="side-icons right-icons">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <!-- Repeat for seamless loop -->
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
    </div>

    <div id="dice-overlay" class="hidden">
        <img src="static/images/classes/DnD_dice_roll.gif" alt="Rolling dice...">
    </div>

    <header>
        <h1 class="unifrakturmaguntia-regular">D&D Character Creator</h1>
        <h4>‚öî UGA Hackathon 2026 Submission ‚öî</h4>
    </header>

    <div class="user-input">
        <textarea id="description" rows="5" cols="50" placeholder="Describe thyself, brave adventurer... What manner of hero art thou?"></textarea>
        <button id="submit">‚öî Create ‚öî</button>
    </div>

    <!-- Example Output Button -->
    <div id="example-controls">
        <button id="example-btn">üìú View Example Character</button>
    </div>


    <br>
    <pre id="result"></pre>

    <!-- Class Display Section -->
    <div id="class-display" class="hidden">
        <div class="class-image-container">
            <img id="class-image" src="" alt="Class Image">
        </div>
        <div class="class-description-container">
            <h2 id="class-name" class="unifrakturmaguntia-regular"></h2>
            <p id="class-description"></p>
        </div>
    </div>

    <!-- Character Info Section -->
    <div id="character-info" class="hidden">
        <div class="character-header">
            <h2 id="character-name" class="unifrakturmaguntia-regular"></h2>
            <div class="character-details">
                <span class="detail-item"><strong>Race:</strong> <span id="char-race"></span></span>
                <span class="detail-divider">|</span>
                <span class="detail-item"><strong>Background:</strong> <span id="char-background"></span></span>
            </div>
        </div>
        <div class="backstory-container">
            <h3>üìú Backstory</h3>
            <p id="char-backstory"></p>
        </div>
    </div>

    <!-- PDF Viewer Section -->
    <div id="pdf-viewer-section" class="hidden">
        <h3 class="pdf-title unifrakturmaguntia-regular">‚öî Character Sheet ‚öî</h3>
        <div class="pdf-container">
            <embed id="pdf-viewer" src="" type="application/pdf">
        </div>
        <div class="pdf-download-fallback">
            <a id="pdf-download-link" href="" download="character_sheet.pdf">üìú Download Character Sheet PDF</a>
        </div>
    </div>

    <script src="static/js/classDescriptions.js"></script>
    <script>

        const messages = [
            "‚ú® Consulting the ancient tomes...",
            "üé≤ The dice gods deliberate your fate...",
            "üîÆ Peering into the crystal ball...",
            "üìú The scribes are writing your legend...",
            "‚öóÔ∏è Brewing your destiny in the cauldron...",
            "üêâ Awakening the dragon of knowledge..."
        ];

        function chooseMessage() {
            const index = Math.floor(Math.random() * messages.length);
            return messages[index];
        }

        function displayClassInfo(charClass) {
            const classDisplay = document.getElementById("class-display");
            const classImage = document.getElementById("class-image");
            const className = document.getElementById("class-name");
            const classDesc = document.getElementById("class-description");

            // Get class description from classDescriptions.js
            const classKey = charClass.toLowerCase();
            const classData = classDescriptions[classKey];

            if (classData) {
                className.textContent = classData.name;
                classDesc.textContent = classData.displayText;
            } else {
                className.textContent = charClass;
                classDesc.textContent = "Description not available.";
            }

            // Set the class image (images named like: "Barbarian DND.png", "Wizard DND.png", etc.)
            const displayName = classData ? classData.name : charClass;
            classImage.src = `static/images/classes/${displayName} DND.png`;
            classImage.alt = `${displayName} Class Image`;

            // Show the class display section
            classDisplay.classList.remove("hidden");
        }

        // Display character info function
        function displayCharacterInfo(charData) {
            const charInfo = document.getElementById("character-info");
            document.getElementById("character-name").textContent = charData.name;
            document.getElementById("char-race").textContent = charData.race;
            document.getElementById("char-background").textContent = charData.background;
            document.getElementById("char-backstory").textContent = charData.backstory;
            charInfo.classList.remove("hidden");
        }

        // Display PDF viewer function - supports both URL and Blob
        function displayPdfViewer(pdfUrlOrBlob, filename = "character_sheet.pdf") {
            const pdfSection = document.getElementById("pdf-viewer-section");
            const pdfViewer = document.getElementById("pdf-viewer");
            const downloadLink = document.getElementById("pdf-download-link");
            
            let viewerUrl;
            if (pdfUrlOrBlob instanceof Blob) {
                // Create object URL for blob
                viewerUrl = URL.createObjectURL(pdfUrlOrBlob);
            } else {
                // Add timestamp to bust cache for regular URLs
                viewerUrl = pdfUrlOrBlob + "?t=" + Date.now();
            }
            
            pdfViewer.src = viewerUrl;
            downloadLink.href = viewerUrl;
            downloadLink.download = filename;
            pdfSection.classList.remove("hidden");
            
            // Scroll to PDF section
            pdfSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // Example character data (Bard)
        const exampleCharData = {
            name: "Silvius Nightwhisper",
            race: "Half-Elf",
            background: "Charlatan",
            backstory: "Silvius learned early that a silver tongue and quick thinking could open more doors than brute force. He uses his natural charisma and perfect memory to weave elaborate deceptions that help those in need, though his methods often blur the line between right and wrong."
        };

        // Example button handler - fetches PDF from server
        document.getElementById("example-btn").addEventListener("click", async () => {
            const btn = document.getElementById("example-btn");
            const originalText = btn.textContent;
            btn.textContent = "‚è≥ Loading...";
            btn.disabled = true;
            
            try {
                // Show class info and character details
                displayClassInfo("bard");
                displayCharacterInfo(exampleCharData);
                
                // Fetch PDF from server
                const response = await fetch("/test-bard-pdf");
                if (response.ok) {
                    const blob = await response.blob();
                    displayPdfViewer(blob, "SilviusNightwhisper_Level3.pdf");
                } else {
                    console.error("Failed to load example PDF");
                }
            } catch (error) {
                console.error("Error loading example:", error);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        });

        document.getElementById("submit").addEventListener("click", async () => {
            const description = document.getElementById("description").value;
            const resultBox = document.getElementById("result");
            const overlay = document.getElementById("dice-overlay");

            resultBox.textContent = chooseMessage();
            resultBox.classList.add('loading');

            try {
                overlay.classList.remove('hidden');

                const response = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ description })
                });

                // Force a minimum wait of 2 seconds so the GIF can play
                await new Promise(resolve => setTimeout(resolve, 2000));

                //const data = await response.json();
                //resultBox.textContent = data.character_sheet;
                if (response.headers.get("content-type").includes("application/pdf")) {
                    // Get character info from response headers
                    const charClass = response.headers.get("X-Character-Class") || "Unknown";
                    const charName = response.headers.get("X-Character-Name") || "Unknown Hero";
                    const charRace = response.headers.get("X-Character-Race") || "Unknown";
                    const charBackground = response.headers.get("X-Character-Background") || "Unknown";
                    const charBackstory = response.headers.get("X-Character-Backstory") || "A mysterious adventurer...";
                    
                    const blob = await response.blob();
                    
                    // Display the class image and description
                    displayClassInfo(charClass);
                    
                    // Display character info
                    displayCharacterInfo({
                        name: charName,
                        race: charRace,
                        background: charBackground,
                        backstory: charBackstory
                    });
                    
                    // Display PDF in viewer
                    displayPdfViewer(blob, `${charName.replace(/\s+/g, '_')}_character_sheet.pdf`);
                    
                    resultBox.textContent = "‚ú® Your legend has been forged! View your character sheet below. ‚ú®";
                } else {
                    console.log(response)
                    const data = await response.json();
                    resultBox.textContent = "‚ö†Ô∏è The spell fizzled: " + (data.error || "Unknown arcane error");
                    console.log(data);
                }

            } catch (error) {
                console.error("Backend is down!,", error);
                resultBox.textContent = "üèöÔ∏è The tavern is closed... (The server has fallen to darkness)";
            } finally {
                overlay.classList.add("hidden");
            }

        });

    </script>

</body>

</html>