<!DOCTYPE html>
<html>

<head>
    <title>D&D Character Creator</title>
    <link rel="stylesheet" href="static/css/style.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=UnifrakturMaguntia&family=Cinzel:wght@400;600;700&family=MedievalSharp&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üêâ</text></svg>">
</head>

<body>

    <!-- Vignette overlay -->
    <div class="vignette"></div>

    <!-- Corner sword decorations -->
    <div class="corner-sword top-left">‚öî</div>
    <div class="corner-sword top-right">‚öî</div>
    <div class="corner-sword bottom-left">‚öî</div>
    <div class="corner-sword bottom-right">‚öî</div>

    <!-- Floating particles/embers effect -->
    <div class="particles">
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
        <div class="particle"></div>
    </div>

    <!-- Left Side Class Icons Column -->
    <div class="side-icons left-icons">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <!-- Repeat for seamless loop -->
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
    </div>

    <!-- Right Side Class Icons Column -->
    <div class="side-icons right-icons">
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
        <!-- Repeat for seamless loop -->
        <img src="static/images/classes/Class Icon - Wizard.svg" alt="Wizard">
        <img src="static/images/classes/Class Icon - Warlock.svg" alt="Warlock">
        <img src="static/images/classes/Class Icon - Sorcerer.svg" alt="Sorcerer">
        <img src="static/images/classes/Class Icon - Rogue.svg" alt="Rogue">
        <img src="static/images/classes/Class Icon - Ranger.svg" alt="Ranger">
        <img src="static/images/classes/Class Icon - Paladin.svg" alt="Paladin">
        <img src="static/images/classes/Class Icon - Monk.svg" alt="Monk">
        <img src="static/images/classes/Class Icon - Fighter.svg" alt="Fighter">
        <img src="static/images/classes/Class Icon - Druid.svg" alt="Druid">
        <img src="static/images/classes/Class Icon - Cleric.svg" alt="Cleric">
        <img src="static/images/classes/Class Icon - Bard.svg" alt="Bard">
        <img src="static/images/classes/Class Icon - Barbarian.svg" alt="Barbarian">
        <img src="static/images/classes/Class Icon - Artificer.svg" alt="Artificer">
    </div>

    <div id="dice-overlay" class="hidden">
        <img src="static/images/classes/DnD_dice_roll.gif" alt="Rolling dice...">
    </div>

    <header>
        <h1 class="unifrakturmaguntia-regular">D&D Character Creator</h1>
        <h4>‚öî UGA Hackathon 2026 Submission ‚öî</h4>
    </header>

    <div class="user-input">
        <textarea id="description" rows="5" cols="50" placeholder="Describe thyself, brave adventurer... What manner of hero art thou?"></textarea>
        <button id="submit">‚öî Create ‚öî</button>
    </div>

    <!-- Test Controls (remove before production) -->
    <div id="test-controls">
        <label for="test-class">Test Class Display: </label>
        <select id="test-class">
            <option value="artificer">Artificer</option>
            <option value="barbarian">Barbarian</option>
            <option value="bard" selected>Bard</option>
            <option value="cleric">Cleric</option>
            <option value="druid">Druid</option>
            <option value="fighter">Fighter</option>
            <option value="monk">Monk</option>
            <option value="paladin">Paladin</option>
            <option value="ranger">Ranger</option>
            <option value="rogue">Rogue</option>
            <option value="sorcerer">Sorcerer</option>
            <option value="warlock">Warlock</option>
            <option value="wizard">Wizard</option>
        </select>
        <button id="test-btn">Test</button>
    </div>


    <br>
    <pre id="result"></pre>

    <!-- Class Display Section -->
    <div id="class-display" class="hidden">
        <div class="class-image-container">
            <img id="class-image" src="" alt="Class Image">
        </div>
        <div class="class-description-container">
            <h2 id="class-name" class="unifrakturmaguntia-regular"></h2>
            <p id="class-description"></p>
        </div>
    </div>

    <!-- Character Info Section -->
    <div id="character-info" class="hidden">
        <div class="character-header">
            <h2 id="character-name" class="unifrakturmaguntia-regular"></h2>
            <div class="character-details">
                <span class="detail-item"><strong>Race:</strong> <span id="char-race"></span></span>
                <span class="detail-divider">|</span>
                <span class="detail-item"><strong>Background:</strong> <span id="char-background"></span></span>
            </div>
        </div>
        <div class="backstory-container">
            <h3>üìú Backstory</h3>
            <p id="char-backstory"></p>
        </div>
    </div>

    <!-- PDF Viewer Section -->
    <div id="pdf-viewer-section" class="hidden">
        <h3 class="pdf-title unifrakturmaguntia-regular">‚öî Character Sheet ‚öî</h3>
        <div class="pdf-container">
            <embed id="pdf-viewer" src="" type="application/pdf">
        </div>
        <div class="pdf-download-fallback">
            <a id="pdf-download-link" href="" download="character_sheet.pdf">üìú Download Character Sheet PDF</a>
        </div>
    </div>

    <script src="static/js/classDescriptions.js"></script>
    <script>

        const messages = [
            "‚ú® Consulting the ancient tomes...",
            "üé≤ The dice gods deliberate your fate...",
            "üîÆ Peering into the crystal ball...",
            "üìú The scribes are writing your legend...",
            "‚öóÔ∏è Brewing your destiny in the cauldron...",
            "üêâ Awakening the dragon of knowledge..."
        ];

        function chooseMessage() {
            const index = Math.floor(Math.random() * messages.length);
            return messages[index];
        }

        function displayClassInfo(charClass) {
            const classDisplay = document.getElementById("class-display");
            const classImage = document.getElementById("class-image");
            const className = document.getElementById("class-name");
            const classDesc = document.getElementById("class-description");

            // Get class description from classDescriptions.js
            const classKey = charClass.toLowerCase();
            const classData = classDescriptions[classKey];

            if (classData) {
                className.textContent = classData.name;
                classDesc.textContent = classData.displayText;
            } else {
                className.textContent = charClass;
                classDesc.textContent = "Description not available.";
            }

            // Set the class image (images named like: "Barbarian DND.png", "Wizard DND.png", etc.)
            const displayName = classData ? classData.name : charClass;
            classImage.src = `static/images/classes/${displayName} DND.png`;
            classImage.alt = `${displayName} Class Image`;

            // Show the class display section
            classDisplay.classList.remove("hidden");
        }

        // Display character info function
        function displayCharacterInfo(charData) {
            const charInfo = document.getElementById("character-info");
            document.getElementById("character-name").textContent = charData.name;
            document.getElementById("char-race").textContent = charData.race;
            document.getElementById("char-background").textContent = charData.background;
            document.getElementById("char-backstory").textContent = charData.backstory;
            charInfo.classList.remove("hidden");
        }

        // Display PDF viewer function
        function displayPdfViewer(pdfUrl) {
            const pdfSection = document.getElementById("pdf-viewer-section");
            const pdfViewer = document.getElementById("pdf-viewer");
            const downloadLink = document.getElementById("pdf-download-link");
            
            // Add timestamp to bust cache
            const urlWithTimestamp = pdfUrl + "?t=" + Date.now();
            pdfViewer.src = urlWithTimestamp;
            downloadLink.href = urlWithTimestamp;
            pdfSection.classList.remove("hidden");
        }

        // Test bard example data
        const testBardData = {
            name: "Silvius Nightwhisper",
            race: "Half-Elf",
            background: "Charlatan",
            backstory: "Silvius learned early that a silver tongue and quick thinking could open more doors than brute force. He uses his natural charisma and perfect memory to weave elaborate deceptions that help those in need, though his methods often blur the line between right and wrong."
        };

        // Test button handler
        document.getElementById("test-btn").addEventListener("click", () => {
            const selectedClass = document.getElementById("test-class").value;
            displayClassInfo(selectedClass);

            // If bard is selected, also show character info and PDF
            if (selectedClass === "bard") {
                displayCharacterInfo(testBardData);
                displayPdfViewer("static/SilviusNightwhisper_Level3.pdf");
            }
        });

        // Add a dedicated test button for full bard example
        const testFullBardBtn = document.createElement("button");
        testFullBardBtn.id = "test-full-bard";
        testFullBardBtn.textContent = "Test Full Bard Example";
        document.getElementById("test-controls").appendChild(testFullBardBtn);

        testFullBardBtn.addEventListener("click", () => {
            displayClassInfo("bard");
            displayCharacterInfo(testBardData);
            displayPdfViewer("static/SilviusNightwhisper_Level3.pdf");
        });

        document.getElementById("submit").addEventListener("click", async () => {
            const description = document.getElementById("description").value;
            const resultBox = document.getElementById("result");
            const overlay = document.getElementById("dice-overlay");

            resultBox.textContent = chooseMessage();
            resultBox.classList.add('loading');

            try {
                overlay.classList.remove('hidden');

                const response = await fetch("/analyze", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ description })
                });

                // Force a minimum wait of 2 seconds so the GIF can play
                await new Promise(resolve => setTimeout(resolve, 2000));

                //const data = await response.json();
                //resultBox.textContent = data.character_sheet;
                if (response.headers.get("content-type").includes("application/pdf")) {
                    // Get the character class from the response header
                    const charClass = response.headers.get("X-Character-Class") || "Unknown";
                    
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "character_sheet.pdf";
                    a.click();
                    URL.revokeObjectURL(url);
                    resultBox.textContent = "‚ú® Your legend has been forged! Scroll downloaded. ‚ú®";

                    // Display the class image and description
                    displayClassInfo(charClass);
                } else {
                    console.log(response)
                    const data = await response.json();
                    resultBox.textContent = "‚ö†Ô∏è The spell fizzled: " + (data.error || "Unknown arcane error");
                    console.log(data);
                }

            } catch (error) {
                console.error("Backend is down!,", error);
                resultBox.textContent = "üèöÔ∏è The tavern is closed... (The server has fallen to darkness)";
            } finally {
                overlay.classList.add("hidden");
            }

        });

    </script>

</body>

</html>